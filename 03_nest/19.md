<h1>Teste de Software - Jest - Configurando o Ambiente de testes</h1>

<h2>üë£ Passo 01 - Instalar o SuperTest</h2>

Vamos instalar a Biblioteca SuperTest atrav√©s do NPM.

1. Depois de abrir a pasta, abra o **Terminal** do VSCode atrav√©s do menu **Terminal ü°™ New Terminal**
2. Ser√° aberta janela do **Power Shell** na parte inferior da janela do VSCode.
3. Para instalar o **SupeTest**, digite o comando abaixo

```bash
npm install --save-dev supertest
```

4. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/t5t1DeK.png" title="source: imgur.com" /></div>


<h2 >üë£ Passo 02 - Configurar o Banco de dados</h2>

Todos os testes do **M√≥dulo Usuario** ser√£o escritos na Classe de Testes **app.e2e-spec.ts**. A grande vantagem de utilizar esta Classe √© que ela j√° est√° configurada para executar testes a partir do **M√≥dulo App**, ou seja, voc√™ pode escrever testes para qualquer M√≥dulo da aplica√ß√£o sem a necessidade de grandes configura√ß√µes.

1. Vamos abrir a Classe de Testes **app.e2e-spec.ts**, localizada na pasta **test**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/yxWtRqG.png" title="source: imgur.com" /></div>

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao escrever os testes da aplica√ß√£o. Observe que a pasta test est√° localizada fora da pasta src.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

2. A Classe de Testes estar√° implementada com o c√≥digo abaixo:

<div align="center"><img src="https://i.imgur.com/ySg8Iww.png" title="source: imgur.com" /></div>

3. Vamos fazer algumas altera√ß√µes nesta Classe para criar os testes do M√≥dulo Usuario. 

Vamos entender as altera√ß√µes que ser√£o realizadas:

**Linha 6:** Alterar **'AppController (e2e)'** por **'Testes dos M√≥dulos Usu√°rio e Auth (e2e)'**

**Linha 9:** Trocar **beforeEach** por **beforeAll**

**Linha 18 a 23:** Apagar o **M√©todo / (GET)** inteiro

4. Ap√≥s as altera√ß√µes a nossa Classe de Testes ficar√° semelhante a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/G3t2TzG.png" title="source: imgur.com" /></div>

Na sequ√™ncia, vamos configurar o Banco de dados de teste **db_blogpessoal_test**. Este Banco de dados ser√° criado para evitar que os testes modifiquem os dados do Banco de dados principal da aplica√ß√£o.

1. Abra o **MySQL Workbench**
2. Abra uma nova **Query** e digite o comando abaixo para criar o Banco de dados **db_blogpessoal_test** e execute a query clicando no primeiro raio <img src="https://i.imgur.com/9FtJQlk.png" title="source: imgur.com" width="30px"/>.

```sql
CREATE DATABASE db_blogpessoal_test;
```

3. Ao executar a query, ser√° criado o **Banco de Dados**. Na janela **Navigator**, localizada no lado esquerdo da tela, ser√° exibido o Banco de dados **db_blogpessoal_test** na lista de **Schemas**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/QfLC1b5.png" title="source: imgur.com" width="50%"/></div>

4. Caso o Banco de dados **db_blogpessoal** n√£o esteja aparecendo na lista, clique no bot√£o <img src="https://i.imgur.com/YGV5zIh.png" title="source: imgur.com" width="4%"/> **Refresh**, localizado ao lado direito da palavra **Schemas**, na janela **Navigator**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/kVeQuNX.png" title="source: imgur.com" width="50%"/></div>

Para finalizar, vamos configurar a Classe de Testes para utilizar este Banco de dados.


1. Adicione a importa√ß√£o para a Biblioteca **Typeorm** na linha 5, como mostra a imagem abaixo:

   <div align="center"><img src="https://i.imgur.com/BoRqmkA.png" title="source: imgur.com" /></div>

2. Adicione as linhas do trecho de c√≥digo abaixo dentro do array **imports**, na linha 11, **M√©todo beforeAll()**:

```javascript
TypeOrmModule.forRoot({
          type: 'mysql',
          host: 'localhost',
          port: 3306,
          username: 'root',
          password: 'root',
          database: 'db_blogpessoal_test',
          autoLoadEntities: true,
          synchronize: true,
          logging: false,
          dropSchema: true
        }),
```

3. A altera√ß√£o acima est√° destacada na imagem abaixo na cor verde:

<div align="center"><img src="https://i.imgur.com/x5KZUpk.png" title="source: imgur.com" /></div>

4. Acrescente o trecho de c√≥digo abaixo, na sequ√™ncia do M√©todo **.compile()** (linha 26), dentro do **M√©todo beforeAll()**:

```javascript
 	app = moduleFixture.createNestApplication();
    await app.init();
```

5. A altera√ß√£o acima est√° destacada na imagem abaixo na cor verde:

<div align="center"><img src="https://i.imgur.com/AOSGo1n.png" title="source: imgur.com" /></div>

6. Acrescente o M√©todo **afterAll()**, trecho de c√≥digo abaixo, depois do M√©todo **beforeAll()**:

```javascript
  afterAll(async () => {
    await app.close();
  });
```

7. A altera√ß√£o acima est√° destacada na imagem abaixo na cor verde:

<div align="center"><img src="https://i.imgur.com/UM4OCNH.png" title="source: imgur.com" /></div>

Vamos entender as altera√ß√µes efetuadas:

O **M√©todo beforeAll()**, tem a responsabilidade de criar o M√≥dulo de Testes da aplica√ß√£o (**Test.createTestingModule()**), definindo:

- O Banco de dados que ser√° utilizado durante os testes (**db_blogpessoal_test**) como o Banco de dados padr√£o (**TypeOrmModule.forRoot()**).
- O(s) M√≥dulo(s) que ser√£o testados no ambiente de testes (**AppModule**), para gerar um ambiente de testes Jest  (**.compile()**). Como adicionamos o M√≥dulo AppModule, podeemos criar testes para qualquer M√≥dulo da aplica√ß√£o dentro desta Classe de testes.

Ap√≥s criarmos o ambiente, o pr√≥ximo passo √© inicializar o ambiente de testes como uma aplica√ß√£o (**app.init()**), da mesma forma que inicializamos a aplica√ß√£o na **Classe Main**.

O **M√©todo afterAll()**, tem a responsabilidade de finalizar o M√≥dulo de Testes quando todos os testes forem executados e finalizados, atrav√©s do M√©todo **app.close()**.

O C√≥digo final, voc√™ confere abaixo:

```javascript
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import * as request from 'supertest';
import { AppModule } from './../src/app.module';
import { TypeOrmModule } from '@nestjs/typeorm';

describe('Testes dos M√≥dulos Usu√°rio e Auth (e2e)', () => {
  let app: INestApplication;

  beforeEach(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [
        TypeOrmModule.forRoot({
          type: 'mysql',
          host: 'localhost',
          port: 3306,
          username: 'root',
          password: 'root',
          database: 'db_blogpessoal_test',
          autoLoadEntities: true,
          synchronize: true,
          logging: false,
          dropSchema: true
        }),
        AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  afterAll(async () => {
    await app.close();
  });
  
});
```

Agora estamos prontos para escrever os nossos testes!	

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>
