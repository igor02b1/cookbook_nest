<h1>Projeto 02 - Blog Pessoal - M√≥dulo Auth - Parte 02</h1>

O que veremos por aqui:

1. Instala√ß√£o do Passport Local e Passport JWT
2. Criar a Classe LocalAuthGuard
4. Criar a Classe LocalStrategy
5. Criar a Classe Constant
5. Criar a Classe JwtAuthGuard
6. Criar a Classe JwtStrategy
7. Registrar a Classe Bcrypt na Classe AuthModule
8. Registrar a Classe AuthModule na Classe AppModule

<h2>1. O M√≥dulo Auth</h2>

Nesta etapa vamos implementar a seguran√ßa da aplica√ß√£o atrav√©s da Biblioteca Passport. Iremos implementar 2 estrat√©gias:

1. **Local:** Basicamente seria o processo de autentica√ß√£o do usu√°rio (login).
2. **JWT:** O processo de gera√ß√£o do Token de Autoriza√ß√£o no formato JWT (JSON WEB Token)

A implementa√ß√£o da Security ser√° composta por 7 Classes:

| Classe             | Descri√ß√£o                                                    |
| ------------------ | ------------------------------------------------------------ |
| **LocalAuthGuard** | Classe respons√°vel por criar o Guard Local, ou seja, atrav√©s da implementa√ß√£o de uma heran√ßa da Classe AuthGuard, o Passport criar√° um Guard personalizado, chamado **local**, que ser√° utilizado pelo endpoint de autentica√ß√£o para processar as credenciais do usu√°rio (usuario e senha). |
| **LocalStrategy**  | Classe respons√°vel por implementar a Local Strategy do Passport, ou seja, a autentica√ß√£o local via Banco de dados. |
| **Constants**      | Definir√° a chave secreta de assinatura do Token JWT          |
| **JwtAuthGuard**   | Classe respons√°vel por criar o Guard JWT, ou seja, atrav√©s da implementa√ß√£o de uma heran√ßa da Classe AuthGuard, o Passport criar√° um Guard personalizado, chamado **jwt**, que ser√° utilizado por todos os endpoints protegidos pelo Token de Autoriza√ß√£o, para validar o Token JWT gerado na autentica√ß√£o. |
| **JwtStrategy**    | Classe respons√°vel por implementar a JWT Strategy do Passport, ou seja, a valida√ß√£o do Token. |
| **AuthService**    | Classe Respons√°vel por criar os M√©todos de autentica√ß√£o e gera√ß√£o do Token JWT. |
| **AuthController** | Classe Respons√°vel por criar o endpoint de autentica√ß√£o.     |

Na parte 02, vamos implementar as 5 primeiras Classes e na parte 03 implementaremos as 2 ultimas Classes e faremos os testes no Insomnia.

<br />

<h2>üë£ Passo 01- Instala√ß√£o do Pacote Passport</h2>

Vamos instalar os Pacotes do Passport atrav√©s do NPM.

1. Abra o **Terminal** do VSCode atrav√©s do menu **Terminal ü°™ New Terminal**
2. Ser√° aberta janela do **Power Shell** na parte inferior da janela do VSCode.
3. Para instalar o **Passport-Local**, digite o comando abaixo:

```bash
npm install --save @nestjs/passport passport passport-local
```

4. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/myR8c8V.png?1" title="source: imgur.com" /></div>

5. Para instalar o **Types-Passport-Local**, digite o comando abaixo:

```bash
npm install --save-dev @types/passport-local
```

6. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/L0XxXr9.png?1" title="source: imgur.com" /></div>

7. Para instalar o **Passport-Jwt**, digite o comando abaixo:

```bash
npm install --save @nestjs/jwt passport-jwt
```

8. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/TZNPQ0Q.png?1" title="source: imgur.com" /></div>

9. Para instalar o **Types-Passport-Jwt**, digite o comando abaixo:

```bash
npm install --save-dev @types/passport-jwt
```

10. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/7z5iTkE.png?1" title="source: imgur.com" /></div>

<br />

<h2>üë£ Passo 02 - Atualizar a estrutura de pastas do M√≥dulo Auth</h2>

Vamos criar algumas pastas no M√≥dulo Auth:

1. Na pasta **auth**, clique com o bot√£o direito do mouse e clique na op√ß√£o **New Folder** (Nova Pasta). 

2. Crie a pasta **constants**. Ap√≥s digitar o nome da pasta, pressione a tecla **enter** do seu teclado para concluir. 

3. Clique com o bot√£o direito do mouse sobre a pasta **auth** e clique na op√ß√£o **New Folder** (Nova Pasta). 

4. Crie a pasta  **controllers**. Ap√≥s digitar o nome da pasta, pressione a tecla **enter** do seu teclado para concluir. 

5. Clique com o bot√£o direito do mouse sobre a pasta **auth** e clique na op√ß√£o **New Folder** (Nova Pasta). 

6. Crie a pasta  **guard**. Ap√≥s digitar o nome da pasta, pressione a tecla **enter** do seu teclado para concluir. 
7. Clique com o bot√£o direito do mouse sobre a pasta **auth** e clique na op√ß√£o **New Folder** (Nova Pasta). 
8. Crie a pasta  **services**. Ap√≥s digitar o nome da pasta, pressione a tecla **enter** do seu teclado para concluir. 
9. Clique com o bot√£o direito do mouse sobre a pasta **auth** e clique na op√ß√£o **New Folder** (Nova Pasta). 
10. Crie a pasta  **strategy**. Ap√≥s digitar o nome da pasta, pressione a tecla **enter** do seu teclado para concluir. 
11. A estrutura de pastas do **M√≥dulo Auth**, ficar√° igual a imagem abaixo:


<div align="center"><img src="https://i.imgur.com/Asiq9z2.png" title="source: imgur.com" /></div>

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="90px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar as novas pastas dentro do M√≥dulo Auth. Um erro muito comum √© criar as pastas fora da pasta do m√≥dulo (auth).* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h2>üë£ Passo 03 - Criar a Classe LocalAuthGuard</h2>

Neste passo, vamos criar a Classe **LocalAuthGuard**, que chamaremos de **local-auth.guard.ts**. Nesta Classe vamos criar o **Guard** personalizado, que ser√° utilizado pelo endpoint de autentica√ß√£o para processar as credenciais do usu√°rio (usuario e senha). 

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar Classe LocalAuthGUard. Um erro muito comum √© digitar o nome da Classe de forma incorreta. O nome da Classe deve estar dentro dos padr√µes do Nest para evitar erros na sua aplica√ß√£o.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

1. Clique com o bot√£o direito do mouse sobre a **pasta guard**, que foi criada dentro da pasta **auth**, e clique na op√ß√£o **New File** (Novo Arquivo).

2. O nome do arquivo ser√° **local-auth.guard.ts**. Ap√≥s digitar o nome do arquivo, pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/BKdtpvo.png" title="source: imgur.com" /></div>

Agora vamos criar o c√≥digo da Classe **LocalAuthGuard**:

```typescript
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class LocalAuthGuard extends AuthGuard('local') {}
```

Observe que foi criada a Classe de Servi√ßo **LocalAuthGuard** *estendendo* a Classe **AuthGuard**, Strategy **local**.

Essa Classe ser√° utilizada na Classe **AuthController**, no M√©todo **login**, para habilitar a **Estrat√©gia Local do Passport**, ou seja, autentica√ß√£o local, via Banco de dados.

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://docs.nestjs.com/security/authentication" target="_blank"><b>Documenta√ß√£o: NestJS Authentication</b></a></div>

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://docs.nestjs.com/guards" target="_blank"><b>Documenta√ß√£o: NestJS Guards</b></a></div>

<div align="left"><img src="https://i.imgur.com/51OZ5ug.png" title="source: imgur.com" width="30px"/> <a href="https://www.passportjs.org/packages/passport-local/" target="_blank"><b>Documenta√ß√£o: Passport Local Strategy</b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="25px"/> <a href="" target="_blank"><b>C√≥digo fonte da Classe LocalAuthGuard</b></a>
<br /></div>
<br />

<h2>üë£ Passo 04 - Criar a Classe LocalStrategy</h2>

Neste passo, vamos criar a Classe **LocalStrategy**, que chamaremos de **local.strategy.ts**. Nesta Classe vamos implementar o **Local Strategy do Pacote Passport**, que ser√° utilizado pelo endpoint de autentica√ß√£o para validar as credenciais do usu√°rio (usuario e senha). 

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar Classe LocalAuthGUard. Um erro muito comum √© digitar o nome da Classe de forma incorreta. O nome da Classe deve estar dentro dos padr√µes do Nest para evitar erros na sua aplica√ß√£o.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

1. Clique com o bot√£o direito do mouse sobre a **pasta strategy**, que foi criada dentro da pasta **auth**, e clique na op√ß√£o **New File** (Novo Arquivo).

2. O nome do arquivo ser√° **local.strategy.ts**. Ap√≥s digitar o nome do arquivo, pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/U6a7YeS.png" title="source: imgur.com" /></div>

Agora vamos criar o c√≥digo da Classe **LocalStrategy**:

<div align="center"><img src="https://i.imgur.com/eaA0xqU.png" title="source: imgur.com" /></div>

**Linha 7:** Cria a Classe de Servi√ßo **LocalStrategy** *estendendo* a Classe **PassportStrategy**, que possui o par√¢metro  **Strategy**. Este par√¢metro ser√° enviado pelo pacote passport-local (importado na linha 3), respons√°vel por implementar a **Local Strategy do Passport**.

**Linha 8:** Cria o M√©todo Construtor, que receber√° as Inje√ß√µes de Depend√™ncia. Como precisaremos ter acesso aos M√©todos da **Classe AuthService**, foi injetado um Objeto desta Classe dentro do Construtor.

**Linhas 9, 10 e 11:** Dentro do M√©todo Construtor da Classe, chamamos o m√©todo **super()**. A estrat√©gia local do Passport espera apenas os Atributos **username e password**, entretanto, a Classe Auxiliar **UsuarioLogin** n√£o possuem estes 2 Atributos, ela foi implementada com os Atributos **usuario e senha**. Para utilizar os Atributos da Classe UsuarioLogin precisamos configurar as propriedades **usernameField e passwordField**, dentro do M√©todo **super()** para que o Passport passe a esperar pelos Atributos usuario e senha.

> **M√©todo super():** O M√©todo super() executa o Construtor da classe base, ou seja, a Classe que est√° sendo estendida (herdada). Sempre que precisarmos acessar uma propriedade no corpo do M√©todo Construtor da Classe Base, temos que chamar o M√©todo super().

**Linha 15:** Criamos o M√©todo Ass√≠ncrono (async), chamado **validate(username: string, password: string)**, que promete retornar uma **Promise** com **apenas um** Objeto do tipo **any**. 

Observe que o M√©todo **validate(username: string, password: string)** possui dois par√¢metros do tipo **string**, chamados **usuario e senha**. Estes par√¢metros ser√£o recebidos na autentica√ß√£o (login) do usu√°rio.

**Linha 16:** Criamos um Objeto da Classe Usuario do tipo **const**, chamado **user**, que receber√° o resultado da execu√ß√£o do M√©todo **validateUser(username, password)**, da Classer **AuthService**, que valida se o usu√°rio existe e se a senha digitada est√° correta. Caso as 2 valida√ß√µes estejam corretas, ser√° retornado um Objeto da Classe Usuario, sem a o Atributo senha, por quest√µes de seguran√ßa e boas pr√°ticas. 

> **const:** Declara uma vari√°vel ou Objeto cujo o valor deve ser declarado previamente, uma vez que o valor recebido n√£o pode ser alterado. Este tipo de vari√°vel ou Objeto s√£o conhecidos como **constantes**.

**Linha 17:** Verifica se o Objeto user n√£o foi encontrado. Caso o usu√°rio digite um e-mail inv√°lido ou que n√£o exista e/ou a senha incorreta, o Objeto user ser√° nulo, causando um erro na nossa aplica√ß√£o. Para evitar este erro, checamos se o Objeto user √© nulo (!user).

**Linha 18:** Se o Objeto user n√£o for encontrado (Nulo), ser√° retornado o HTTP Status **UNAUTHORIZED ü°™ 401** (Acesso n√£o autorizado!), na forma de uma **Exception**.

**Linha 20:** Se o Objeto user for encontrado, o M√©todo retorna o Objeto user para a Classe que acionou o M√©todo.

Essa Classe ser√° utilizada na Classe **AuthController**, no M√©todo **login**, para habilitar a **Estrat√©gia Local do Passport**, ou seja, autentica√ß√£o local, via Banco de dados.

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://docs.nestjs.com/security/authentication" target="_blank"><b>Documenta√ß√£o: NestJS Authentication</b></a></div>

<div align="left"><img src="https://i.imgur.com/51OZ5ug.png" title="source: imgur.com" width="30px"/> <a href="https://www.passportjs.org/packages/passport-local/" target="_blank"><b>Documenta√ß√£o: Passport Local Strategy</b></a></div>

<div align="left"><img src="https://i.imgur.com/izFuHID.png" title="source: imgur.com" width="30px"/> <a href="https://www.typescriptlang.org/docs/handbook/2/classes.html" target="_blank"><b>Documenta√ß√£o: Classes e M√©todos</b></a></div>

<div align="left"><img src="https://i.imgur.com/izFuHID.png" title="source: imgur.com" width="30px"/> <a href="https://www.typescriptlang.org/docs/handbook/variable-declarations.html#let-vs-const" target="_blank"><b>Documenta√ß√£o: Decalara√ß√£o de variaveis</b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/13_Security_JWT/blogpessoal/src/auth/strategy/local.strategy.ts" target="_blank"><b>C√≥digo fonte da Classe LocalAuthGuard</b></a>
<br /></div>

<br />

<h2>üë£ Passo 05 - Criar a Classe Constant</h2>

Neste passo, vamos criar a Classe **Constants**, que chamaremos de **constant.ts**. Nesta Classe vamos criar uma const, chamada **jwtConstants**, que ir√° armazenar a **chave de assinatura do Token JWT**. 

1. Clique com o bot√£o direito do mouse sobre a **pasta constants**, que foi criada dentro da pasta **auth**, e clique na op√ß√£o **New File** (Novo Arquivo).

2. O nome do arquivo ser√° **constants.ts**. Ap√≥s digitar o nome do arquivo, pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/I8yfHtm.png" title="source: imgur.com" /></div>

Agora vamos criar o c√≥digo da Classe **Constants**:

```typescript
export const jwtConstants = {
    secret: 'secretKey',
  };
```

Observe que foi criada dentro da Classe **Constants**, a const jwtConstants, que receber√° a propriedade secret, que ser√° chave de assinatura do Token JWT.

Essa Classe ser√° utilizada na Classe **JwtStrategy**, para validar o Token enviado no Cabe√ßalho das Requisi√ß√µes enviadas para os endpoints protegidos da aplica√ß√£o e para assinar os Tokens JWT durante a cria√ß√£o do Token.

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ATEN√á√ÉO:** *N√£o devemos expor a chave secreta publicamente. Em um aplicativo em produ√ß√£o, essa chave deve ser protegida usando mecanismos melhores, como vari√°veis de ambiente, cofre secreto ou servi√ßos de configura√ß√£o com base no controle de acesso adequado.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://docs.nestjs.com/security/authentication" target="_blank"><b>Documenta√ß√£o: NestJS Authentication</b></a></div>

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://docs.nestjs.com/guards" target="_blank"><b>Documenta√ß√£o: NestJS Guards</b></a></div>

<div align="left"><img src="https://i.imgur.com/51OZ5ug.png" title="source: imgur.com" width="30px"/> <a href="https://www.passportjs.org/packages/passport-local/" target="_blank"><b>Documenta√ß√£o: Passport Local Strategy</b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/13_Security_JWT/blogpessoal/src/auth/constants/constants.ts" target="_blank"><b>C√≥digo fonte da Classe Constants</b></a>
<br /></div>

<br />

<h2>üë£ Passo 06 - Criar a Classe JwtAuthGuard</h2>

Neste passo, vamos criar a Classe **LocalAuthGuard**, que chamaremos de **local-auth.guard.ts**. Nesta Classe vamos criar o **Guard** personalizado, que ser√° utilizado pelo endpoint de autentica√ß√£o para processar as credenciais do usu√°rio (usuario e senha). 

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar Classe LocalAuthGUard. Um erro muito comum √© digitar o nome da Classe de forma incorreta. O nome da Classe deve estar dentro dos padr√µes do Nest para evitar erros na sua aplica√ß√£o.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

1. Clique com o bot√£o direito do mouse sobre a **pasta guard**, que foi criada dentro da pasta **auth**, e clique na op√ß√£o **New File** (Novo Arquivo).

2. O nome do arquivo ser√° **local-auth.guard.ts**. Ap√≥s digitar o nome do arquivo, pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/mMvFO76.png" title="source: imgur.com" /></div>

Agora vamos criar o c√≥digo da Classe **LocalAuthGuard**:

```typescript
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class LocalAuthGuard extends AuthGuard('local') {}
```

**Linha 5:** Cria a Classe de Servi√ßo **LocalAuthGuard** *herdando* a Classe **AuthGuard**, Strategy **local**.

Essa Classe ser√° utilizada na Classe **AuthController**, no M√©todo **login**, para habilitar a **Estrat√©gia Local do Passport**, ou seja, autentica√ß√£o local, via Banco de dados.

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="25px"/> <a href="" target="_blank"><b>C√≥digo fonte da Classe LocalAuthGuard</b></a>
<br /></div>
<br />
