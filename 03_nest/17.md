<h1>Projeto 02 - Blog Pessoal - M√≥dulo Auth - Parte 02</h1>

O que veremos por aqui:

1. Instala√ß√£o do Passport Local, Passport JWT e @nestjs/jwt
2. Criar a Classe LocalAuthGuard
3. Criar a Classe LocalStrategy
4. Criar a Classe Constant
5. Criar a Classe JwtAuthGuard
6. Criar a Classe JwtStrategy
7. Registrar as Classes LocalStrategy e JwtStrategy na Classe AuthModule

<h2>1. O M√≥dulo Auth</h2>

Nesta etapa vamos implementar a seguran√ßa da aplica√ß√£o atrav√©s da Biblioteca Passport. Iremos implementar 2 estrat√©gias:

1. **Local:** Basicamente seria o processo de autentica√ß√£o do usu√°rio (login).
2. **JWT:** O processo de gera√ß√£o do Token de Autoriza√ß√£o no formato JWT (JSON WEB Token)

A implementa√ß√£o da Security ser√° composta por 7 Classes:

| Classe / Arquivo   | Descri√ß√£o                                                    |
| ------------------ | ------------------------------------------------------------ |
| **LocalAuthGuard** | Classe respons√°vel por criar o Guard Local, ou seja, atrav√©s da implementa√ß√£o de uma heran√ßa da Classe AuthGuard, o Passport criar√° um Guard personalizado, chamado **local**, que ser√° utilizado pelo endpoint de autentica√ß√£o para processar as credenciais do usu√°rio (usuario e senha). |
| **LocalStrategy**  | Classe respons√°vel por implementar a Local Strategy do Passport, ou seja, a autentica√ß√£o local via Banco de dados. |
| **Constants**      | Definir√° a chave secreta de assinatura do Token JWT.         |
| **JwtAuthGuard**   | Classe respons√°vel por criar o Guard JWT, ou seja, atrav√©s da implementa√ß√£o de uma heran√ßa da Classe AuthGuard, o Passport criar√° um Guard personalizado, chamado **jwt**, que ser√° utilizado por todos os endpoints protegidos pelo Token de Autoriza√ß√£o, para validar o Token JWT gerado na autentica√ß√£o. |
| **JwtStrategy**    | Classe respons√°vel por implementar a JWT Strategy do Passport, ou seja, a valida√ß√£o do Token enviado nas requisi√ß√µes. |
| **AuthService**    | Classe Respons√°vel por criar os M√©todos de autentica√ß√£o e gera√ß√£o do Token JWT. |
| **AuthController** | Classe Respons√°vel por criar o endpoint de autentica√ß√£o (login). |

Na parte 02, vamos implementar as 5 primeiras Classes e na parte 03 implementaremos as 2 ultimas Classes e faremos os testes no Insomnia.

<br />

<h2>üë£ Passo 01- Instala√ß√£o dos Pacotes da Biblioteca Passport</h2>

Vamos instalar os Pacotes do Passport atrav√©s do NPM.

1. Abra o **Terminal** do VSCode atrav√©s do menu **Terminal ü°™ New Terminal**
2. Ser√° aberta janela do **Power Shell** na parte inferior da janela do VSCode.
3. Para instalar o **Passport-Local**, digite o comando abaixo:

```bash
npm install --save @nestjs/passport passport passport-local
```

4. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/myR8c8V.png?1" title="source: imgur.com" /></div>

5. Para instalar o **Types-Passport-Local**, digite o comando abaixo:

```bash
npm install --save-dev @types/passport-local
```

6. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/L0XxXr9.png?1" title="source: imgur.com" /></div>

7. Para instalar o **Passport-Jwt**, digite o comando abaixo:

```bash
npm install --save @nestjs/jwt passport-jwt
```

8. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/TZNPQ0Q.png?1" title="source: imgur.com" /></div>

9. Para instalar o **Types-Passport-Jwt**, digite o comando abaixo:

```bash
npm install --save-dev @types/passport-jwt
```

10. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/7z5iTkE.png?1" title="source: imgur.com" /></div>

<br />

<h2>üë£ Passo 02 - Atualizar a estrutura de pastas do M√≥dulo Auth</h2>

Vamos criar algumas pastas no M√≥dulo Auth:

1. Na pasta **auth**, clique com o bot√£o direito do mouse e clique na op√ß√£o **New Folder** (Nova Pasta). 

2. Crie a pasta **constants**. Ap√≥s digitar o nome da pasta, pressione a tecla **enter** do seu teclado para concluir. 

3. Clique com o bot√£o direito do mouse sobre a pasta **auth** e clique na op√ß√£o **New Folder** (Nova Pasta). 

4. Crie a pasta  **controllers**. Ap√≥s digitar o nome da pasta, pressione a tecla **enter** do seu teclado para concluir. 

5. Clique com o bot√£o direito do mouse sobre a pasta **auth** e clique na op√ß√£o **New Folder** (Nova Pasta). 

6. Crie a pasta  **guard**. Ap√≥s digitar o nome da pasta, pressione a tecla **enter** do seu teclado para concluir. 
7. Clique com o bot√£o direito do mouse sobre a pasta **auth** e clique na op√ß√£o **New Folder** (Nova Pasta). 
8. Crie a pasta  **services**. Ap√≥s digitar o nome da pasta, pressione a tecla **enter** do seu teclado para concluir. 
9. Clique com o bot√£o direito do mouse sobre a pasta **auth** e clique na op√ß√£o **New Folder** (Nova Pasta). 
10. Crie a pasta  **strategy**. Ap√≥s digitar o nome da pasta, pressione a tecla **enter** do seu teclado para concluir. 
11. A estrutura de pastas do **M√≥dulo Auth**, ficar√° igual a imagem abaixo:


<div align="center"><img src="https://i.imgur.com/Asiq9z2.png" title="source: imgur.com" /></div>

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="90px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar as novas pastas dentro do M√≥dulo Auth. Um erro muito comum √© criar as pastas fora da pasta do m√≥dulo (auth).* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h2>üë£ Passo 03 - Criar a Classe LocalAuthGuard</h2>

Neste passo, vamos criar a Classe **LocalAuthGuard**, que chamaremos de **local-auth.guard.ts**. Nesta Classe vamos criar o **Guard** personalizado, que ser√° utilizado pelo endpoint de autentica√ß√£o para processar as credenciais do usu√°rio (usuario e senha). 

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar Classe LocalAuthGUard. Um erro muito comum √© digitar o nome da Classe de forma incorreta. O nome da Classe deve estar dentro dos padr√µes do Nest para evitar erros na sua aplica√ß√£o.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

1. Clique com o bot√£o direito do mouse sobre a **pasta guard**, que foi criada dentro da pasta **auth**, e clique na op√ß√£o **New File** (Novo Arquivo).

2. Digite o nome do arquivo (**local-auth.guard.ts**) e pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/BKdtpvo.png" title="source: imgur.com" /></div>

Agora vamos implementar o c√≥digo da Classe **LocalAuthGuard**:

```typescript
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class LocalAuthGuard extends AuthGuard('local') {}
```

Observe que foi criada a Classe de Servi√ßo **LocalAuthGuard** *estendendo* a Classe **AuthGuard**, Strategy **local**.

Essa Classe ser√° utilizada na Classe **AuthController**, no M√©todo **login**, para habilitar a **Estrat√©gia Local do Passport**, ou seja, autentica√ß√£o local, via Banco de dados.

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://docs.nestjs.com/security/authentication" target="_blank"><b>Documenta√ß√£o: NestJS Authentication</b></a></div>

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://docs.nestjs.com/guards" target="_blank"><b>Documenta√ß√£o: NestJS Guards</b></a></div>

<div align="left"><img src="https://i.imgur.com/51OZ5ug.png" title="source: imgur.com" width="30px"/> <a href="https://www.passportjs.org/packages/passport-local/" target="_blank"><b>Documenta√ß√£o: Passport Local Strategy</b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/13_Security_JWT/blogpessoal/src/auth/guard/local-auth.guard.ts" target="_blank"><b>C√≥digo fonte da Classe LocalAuthGuard</b></a>
<br /></div>

<br />

<h2>üë£ Passo 04 - Criar a Classe LocalStrategy</h2>

Neste passo, vamos criar a Classe **LocalStrategy**, que chamaremos de **local.strategy.ts**. Nesta Classe vamos implementar o **Local Strategy do Pacote Passport**, que ser√° utilizado no processo de autentica√ß√£o para validar as credenciais do usu√°rio (usuario e senha). 

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar Classe LocalStrategy. Um erro muito comum √© digitar o nome da Classe de forma incorreta. O nome da Classe deve estar dentro dos padr√µes do Nest para evitar erros na sua aplica√ß√£o.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

1. Clique com o bot√£o direito do mouse sobre a **pasta strategy**, que foi criada dentro da pasta **auth**, e clique na op√ß√£o **New File** (Novo Arquivo).

2. Digite o nome do arquivo (**local.strategy.ts**) e pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/U6a7YeS.png" title="source: imgur.com" /></div>

Agora vamos implementar o c√≥digo da Classe **LocalStrategy**:

<div align="center"><img src="https://i.imgur.com/eaA0xqU.png" title="source: imgur.com" /></div>

**Linha 7:** Cria a Classe de Servi√ßo **LocalStrategy** *estendendo* a Classe **PassportStrategy**, que possui o par√¢metro  **Strategy**. Este par√¢metro ser√° enviado pelo pacote passport-local (importado na linha 3), respons√°vel por implementar a **Local Strategy do Passport**.

**Linha 8:** Cria o M√©todo Construtor, que receber√° as Inje√ß√µes de Depend√™ncia. Como precisaremos ter acesso aos M√©todos da **Classe AuthService**, foi injetado um Objeto desta Classe dentro do Construtor.

**Linhas 9, 10 e 11:** Dentro do M√©todo Construtor da Classe, chamamos o m√©todo **super()**. A estrat√©gia local do Passport espera apenas os Atributos **username e password**, entretanto, a Classe Auxiliar **UsuarioLogin** n√£o possui estes 2 Atributos, ela foi implementada com os Atributos **usuario e senha**. Para utilizar os Atributos da Classe UsuarioLogin precisamos configurar as propriedades **usernameField e passwordField**, dentro do M√©todo **super()** para que o Passport passe a esperar pelos Atributos usuario e senha.

> **M√©todo super():** O M√©todo super() executa o Construtor da classe base, ou seja, a Classe que est√° sendo estendida (herdada). Sempre que precisarmos acessar uma propriedade no corpo do M√©todo Construtor da Classe Base, temos que chamar o M√©todo super().

**Linha 15:** Criamos o M√©todo Ass√≠ncrono (async), chamado **validate(username: string, password: string)**, que promete retornar uma **Promise** com **apenas um** Objeto do tipo **any**. 

Observe que o M√©todo **validate(username: string, password: string)** possui dois par√¢metros do tipo **string**, chamados **usuario e senha**. Estes par√¢metros ser√£o recebidos na autentica√ß√£o (login) do usu√°rio.

**Linha 16:** Criamos um Objeto da Classe Usuario do tipo **const**, chamado **user**, que receber√° o resultado da execu√ß√£o do M√©todo **validateUser(username, password)**, da Classer **AuthService**, que valida se o usu√°rio existe e se a senha digitada est√° correta. Caso as 2 valida√ß√µes estejam corretas, ser√° retornado um Objeto da Classe Usuario, sem o Atributo senha, por quest√µes de seguran√ßa e boas pr√°ticas. 

> **const:** Declara uma vari√°vel ou Objeto cujo o valor deve ser declarado previamente, uma vez que o valor recebido n√£o pode ser alterado. Este tipo de vari√°vel ou Objeto s√£o conhecidos como **constantes**.

**Linha 17:** Verifica se o Objeto user n√£o foi encontrado. Caso o usu√°rio digite um e-mail inv√°lido ou que n√£o exista e/ou a senha incorreta, o Objeto user ser√° nulo, causando um erro na nossa aplica√ß√£o. Para evitar este erro, checamos se o Objeto user √© nulo (!user).

**Linha 18:** Se o Objeto user n√£o for encontrado (Nulo), ser√° retornado o HTTP Status **UNAUTHORIZED ü°™ 401** (Acesso n√£o autorizado!), na forma de uma **Exception**.

**Linha 20:** Se o Objeto user for encontrado, o M√©todo retorna o Objeto user para a Classe que acionou o M√©todo.

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://docs.nestjs.com/security/authentication" target="_blank"><b>Documenta√ß√£o: NestJS Authentication</b></a></div>

<div align="left"><img src="https://i.imgur.com/51OZ5ug.png" title="source: imgur.com" width="30px"/> <a href="https://www.passportjs.org/packages/passport-local/" target="_blank"><b>Documenta√ß√£o: Passport Local Strategy</b></a></div>

<div align="left"><img src="https://i.imgur.com/izFuHID.png" title="source: imgur.com" width="30px"/> <a href="https://www.typescriptlang.org/docs/handbook/2/classes.html" target="_blank"><b>Documenta√ß√£o: Classes e M√©todos</b></a></div>

<div align="left"><img src="https://i.imgur.com/izFuHID.png" title="source: imgur.com" width="30px"/> <a href="https://www.typescriptlang.org/docs/handbook/variable-declarations.html#let-vs-const" target="_blank"><b>Documenta√ß√£o: Decalara√ß√£o de variaveis</b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/13_Security_JWT/blogpessoal/src/auth/strategy/local.strategy.ts" target="_blank"><b>C√≥digo fonte da Classe LocalStrategy</b></a>
<br /></div>

<br />

<h2>üë£ Passo 05 - Criar a const jwtConstants</h2>

Neste passo, vamos criar a const **jwtConstants**, no arquivo chamado **constant.ts**. Neste arquivo vamos criar uma const, chamada **jwtConstants**, que ir√° armazenar a **chave de assinatura do Token JWT**. Todos os Tokens JWT gerados na aplica√ß√£o ser√£o assinados com esta const. Para uma aplica√ß√£o em produ√ß√£o, quanto mais complexa for a chave, mais seguro ser√° o Token JWT. Importante destacar que quando uma requisi√ß√£o receber o Token JWT ele ser√° validado atrav√©s desta chave.

1. Clique com o bot√£o direito do mouse sobre a **pasta constants**, que foi criada dentro da pasta **auth**, e clique na op√ß√£o **New File** (Novo Arquivo).

2. Digite o nome do arquivo (**constants.ts**) e  pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/I8yfHtm.png" title="source: imgur.com" /></div>

Agora vamos implementar o c√≥digo do arquivo **constants.ts**:

```typescript
export const jwtConstants = {
    secret: 'secretKey',
  };
```

Observe que a **const jwtConstants** foi criada dentro do arquivo **constants.ts**. A **const jwtConstants** possui a propriedade **secret**, que armazenar√° a **chave de assinatura do Token JWT**. 

Essa Classe ser√° utilizada na Classe **JwtStrategy**, para validar o Token enviado no Cabe√ßalho das Requisi√ß√µes enviadas para os endpoints protegidos da aplica√ß√£o e tamb√©m ser√° utilizada para assinar os Tokens JWT gerados pelo M√©todo **sign()** da **Classe JwtService**, que ser√° injetada na **Classe AuthService**, para **criar o Token JWT** ap√≥s a autentica√ß√£o (login) do usu√°rio. A **Classe JwtService** pertence ao M√≥dulo **JwtModule** do **Nest** e ser√° registrado na Classe **AuthModule** nos pr√≥ximos passos.

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ATEN√á√ÉO:** *N√£o devemos expor a chave secreta publicamente. Em um aplicativo em produ√ß√£o, essa chave deve ser protegida usando mecanismos melhores, como vari√°veis de ambiente, cofre secreto ou servi√ßos de configura√ß√£o com base no controle de acesso adequado.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://docs.nestjs.com/security/authentication" target="_blank"><b>Documenta√ß√£o: NestJS Authentication</b></a></div>

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://github.com/nestjs/jwt" target="_blank"><b>Documenta√ß√£o: NestJS JwtModule</b></a></div>

<div align="left"><img src="https://i.imgur.com/WeNdbPo.png" title="source: imgur.com" width="35px"/> <a href="https://jwt.io/introduction" target="_blank"><b>Documenta√ß√£o: JWT - JSON WEB Token</b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/13_Security_JWT/blogpessoal/src/auth/constants/constants.ts" target="_blank"><b>C√≥digo fonte do arquivo constants.ts</b></a>
<br /></div>

<br />

<h2>üë£ Passo 06 - Criar a Classe JwtAuthGuard</h2>

Neste passo, vamos criar a Classe **JwtAuthGuard**, que chamaremos de **jwt-auth.guard.ts**. Nesta Classe vamos criar o **Guard** personalizado, que ser√° utilizado por todos os endpoints protegidos ou pela Classe Controladora para proteger todos os seus endpoints, para validar os Tokens JWT recebidos no Cabe√ßalho das Requisi√ß√µes. 

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar Classe JwtAuthGuard. Um erro muito comum √© digitar o nome da Classe de forma incorreta. O nome da Classe deve estar dentro dos padr√µes do Nest para evitar erros na sua aplica√ß√£o.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

1. Clique com o bot√£o direito do mouse sobre a **pasta guard**, que foi criada dentro da pasta **auth**, e clique na op√ß√£o **New File** (Novo Arquivo).

2. Digite o nome do arquivo (**jwt-auth.guard.ts**) e pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/mMvFO76.png" title="source: imgur.com" /></div>

Agora vamos criar o c√≥digo da Classe **JwtAuthGuard**:

```typescript
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {}
```

Observe que foi criada a Classe de Servi√ßo **JwtAuthGuard** *estendendo* a Classe **AuthGuard**, Strategy **jwt**.

Essa Classe ser√° utilizada em todas as **Classes Controladoras** que possuam endpoints protegidos, para habilitar a **Estrat√©gia Jwt do Passport**, ou seja, a valida√ß√£o do Token JWT enviado no cabe√ßalho da Requisi√ß√£o, antes de autorizar o acesso ao endpoint, mesmo que o usu√°rio esteja autenticado.

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://docs.nestjs.com/security/authentication" target="_blank"><b>Documenta√ß√£o: NestJS Authentication</b></a></div>

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://docs.nestjs.com/guards" target="_blank"><b>Documenta√ß√£o: NestJS Guards</b></a></div>

<div align="left"><img src="https://i.imgur.com/WeNdbPo.png" title="source: imgur.com" width="35px"/> <a href="https://jwt.io/introduction" target="_blank"><b>Documenta√ß√£o: JWT - JSON WEB Token</b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/13_Security_JWT/blogpessoal/src/auth/guard/jwt-auth.guard.ts" target="_blank"><b>C√≥digo fonte da Classe JwtAuthGuard</b></a>
<br /></div>

<br />

<h2>üë£ Passo 07 - Criar a Classe JwtStrategy</h2>

Neste passo, vamos criar a Classe **JwtStrategy**, que chamaremos de **jwt.strategy.ts**. Nesta Classe vamos implementar o **Jwt Strategy do Pacote Passport**, que ser√° utilizado por todos os endpoints protegidos das Classes Controladoras,  para validar o Token JWT recebido no Cabe√ßalho das Requisi√ß√µes. 

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar Classe JwtStrategy. Um erro muito comum √© digitar o nome da Classe de forma incorreta. O nome da Classe deve estar dentro dos padr√µes do Nest para evitar erros na sua aplica√ß√£o.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

1. Clique com o bot√£o direito do mouse sobre a **pasta strategy**, que foi criada dentro da pasta **auth**, e clique na op√ß√£o **New File** (Novo Arquivo).

2. Digite o nome do arquivo (**jwt.strategy.ts**) e pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/2EAGT89.png" title="source: imgur.com" /></div>

Agora vamos criar o c√≥digo da Classe **JwtStrategy**:

<div align="center"><img src="https://i.imgur.com/68piLwg.png" title="source: imgur.com" /></div>

**Linha 7:** Cria a Classe de Servi√ßo **JwtStrategy** *estendendo* a Classe **PassportStrategy**, que possui o par√¢metro  **Strategy**. Este par√¢metro ser√° enviado pelo pacote passport-jwt (importado na linha 3), respons√°vel por implementar a **Jwt Strategy do Passport**.

**Linha 8:** Cria o M√©todo Construtor.

**Linha 9:** Dentro do M√©todo Construtor da Classe, chamamos o m√©todo **super()**. Para utilizar a estrat√©gia jwt do Passport precisamos configurar algumas propriedades da Classe herdada. Para configurar as propriedades da Classe heradada, assim como fizemos na Classe **LocalStrategy**, vamos utilizar o M√©todo **super()**. 

**Linha 10:** Na propriedade **jwtFromRequest** informamos o M√©todo com o qual extrairemos o Token JWT da Requisi√ß√£o. Basicamente, usamos o m√©todo **fromAuthHeaderAsBearerToken()** do pacote **ExtractJwt**, que extrai o Token JWT do Cabe√ßalho da Requisi√ß√£o. Passar o Token JWT como um **Bearer Token** no Cabe√ßalho de Autoriza√ß√£o (Authorization) da Requisi√ß√£o √© uma pr√°tica comum. 

Na imagem abaixo, vemos o Cabe√ßalho de uma Requisi√ß√£o HTTP com o Token Bearer, na propriedade **Authorization**:

<div align="center"><img src="https://i.imgur.com/rvvLw2X.png" title="source: imgur.com" /></div>

**Linha 11:** Na propriedade **ignoreExpiration** definimos o seu valor como false. Isso basicamente significa que queremos bloquear solicita√ß√µes com tokens expirados. Se uma Requisi√ß√£o for enviada com um token expirado, nosso aplicativo retornar√° o **HTTP Status UNAUTHORIZED ü°™ 401** (N√£o autorizado ).

**Linha 12:** Na propriedade **secretOrKey** informamos que a chave de assinatura do Token JWT est√° armazenada no arquivo  **constants.ts**, na **const jwtConstants**, na propriedade **secret**. Lembrando que em Produ√ß√£o, esta chave deve estar codificada e/ou protegida por quest√µes de seguran√ßa.

**Linha 16:** Criamos o M√©todo Ass√≠ncrono (async), chamado **validate(payload: any)**. 

Observe que o M√©todo **validate(payload: any)** possui um par√¢metro do tipo **any**, chamados **payload**. Este par√¢metro ser√° gerado na autentica√ß√£o (login) do usu√°rio.

**Linha 17:** Retorna o Objeto do usuario contendo os Atributos extra√≠dos do **payload**. 

> **payload:** √© um Objeto JSON, que cont√©m as declara√ß√µes do Token JWT, definidas no padr√£o JSON WEB Token. As declara√ß√µes s√£o as informa√ß√µes sobre uma entidade (normalmente, o usu√°rio) e alguns dados adicionais.

Pode parecer um pouco estranho num primeiro momento o M√©todo **validate(payload: any)** receber o payload e retornar um Objeto contendo um JSON com as propriedades do pr√≥prio payload. Para entender o porqu√™ precisamos compreender como o **JWT Strategy** funciona na pr√°tica:

1. Primeiro o Passport verifica se a assinatura do Token JWT recebido no Cabe√ßalho da Requisi√ß√£o √© a mesma que foi definida na propriedade **secret**, da **const jwtConstant**, no arquivo **constant.ts**. 

2. Depois de validar a assinatura, o Passport decodifica o Objeto JSON, que est√° dentro do Token, extraindo o **Payload**. 

3. Somente depois de concluir estes 2 processos que o Passport executar√° o M√©todo **validate(payload: any)** que recebe **o JSON decodificado contendo o payload**. 

Este processo garante que, se o M√©todo **validate(payload: any)** for chamado, significa que o **JWT Token foi validado**.   

Veja o exemplo de um Token decodificado na imagem abaixo: 

<div align="center"><img src="https://i.imgur.com/pfINr0d.png" title="source: imgur.com" /></div>

Atrav√©s da ferramenta **Debugger**, dispon√≠vel no site oficial do JWT, inserimos o Token Bearer, que foi enviado no Cabe√ßalho da Requisi√ß√£o, no campo **Encoded**. Observe que a palavra **Bearer n√£o foi adicionada**, inserimos apenas a parte codificada do Token. 

No campo **Decoded** a ferramenta extraiu o JSON, da mesma forma que o Passport faz. Observe que no item payload (destacado em vermelho), temos o JSON com os dados (sub, username), que ser√£o retornados pelo M√©todo **validate(payload: any)**.

| <img src="https://i.imgur.com/RfjtOFi.png" title="source: imgur.com" width="100px"/> | <div align="left"> **DICA:** *A compreens√£o do M√©todo validate(payload: any) ficar√° mais simples quando implementarmos a Classe AuthService, onde o Token JWT e o payload s√£o gerados*.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://docs.nestjs.com/security/authentication" target="_blank"><b>Documenta√ß√£o: NestJS Authentication</b></a></div>

<div align="left"><img src="https://i.imgur.com/51OZ5ug.png" title="source: imgur.com" width="30px"/> <a href="https://www.passportjs.org/packages/passport-jwt/" target="_blank"><b>Documenta√ß√£o: Passport Jwt Strategy</b></a></div>

<div align="left"><img src="https://i.imgur.com/izFuHID.png" title="source: imgur.com" width="30px"/> <a href="https://www.typescriptlang.org/docs/handbook/2/classes.html" target="_blank"><b>Documenta√ß√£o: Classes e M√©todos</b></a></div>

<div align="left"><img src="https://i.imgur.com/izFuHID.png" title="source: imgur.com" width="30px"/> <a href="https://www.typescriptlang.org/docs/handbook/variable-declarations.html#let-vs-const" target="_blank"><b>Documenta√ß√£o: Decalara√ß√£o de variaveis</b></a></div>

<div align="left"><img src="https://i.imgur.com/WeNdbPo.png" title="source: imgur.com" width="35px"/> <a href="https://jwt.io/introduction" target="_blank"><b>Documenta√ß√£o: JWT - JSON WEB Token</b></a></div>

<div align="left"><img src="https://i.imgur.com/WeNdbPo.png" title="source: imgur.com" width="35px"/> <a href="https://jwt.io/" target="_blank"><b>Ferramenta: JWT Debugger</b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/13_Security_JWT/blogpessoal/src/auth/strategy/jwt.strategy.ts" target="_blank"><b>C√≥digo fonte da Classe JwtStrategy</b></a>
<br /></div>

<br />

<h2>üë£ Passo 08 - Registrar as Classes LocalStrategy, JwtStrategy e Importar os M√≥dulos UsuarioModule, PassportModule e JwtModule na Classe AuthModule</h2>

Vamos registrar as **Classes LocalStrategy, JwtStrategy** e importar os **M√≥dulos UsuarioModule, PassportModule e JwtModule**. Veja abaixo a implementa√ß√£o da Classe **AuthModule**:

<div align="left"><img src="https://i.imgur.com/3EozNBT.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo:

**Linha 12:** O M√≥dulo **UsuarioModule** foi importado no array **imports**. Precisamos do M√≥dulo UsuarioModule para validar o usu√°rio e senha no Banco de dados da aplica√ß√£o no processo de autentica√ß√£o do usu√°rio (login).

**Linha 13:** O M√≥dulo **PassportModule** foi importado no array **imports**. Precisamos do M√≥dulo PassportModule para implementar o pacote Passport e as suas Strategies.

**Linha 14:** O M√≥dulo **JwtModule** foi importado no array **imports**. Precisamos do M√≥dulo JwtModule para criar o Token JWT. Al√©m de importar o M√≥dulo JwtModule, ser√° necess√°rio executar o M√©todo **register()** para configurar algumas propriedades.

**Linha 15:** Configura a propriedade **secret** (chave de assinatura do token JWT) com o valor da propriedade **secret da  const jwtConstants**.

**Linha 16:** Configura a propriedade **signOptions** (op√ß√µes do processo de cria√ß√£o do token). Observe que dentro desta propriedade temos um array com as propriedades espec√≠ficas do M√©todo **sign()**, da **Classe JwtService**, do **M√≥dulo JwtModule**. Vamos configurar a propriedade **expiresIn** (tempo de dura√ß√£o do Token JWT), com o valor **24h**. O Token gerado ter√° validade de 24 horas, ap√≥s este per√≠odo ser√° necess√°rio gerar um novo.

Veja o exemplo na imagem abaixo:

<div align="center"><img src="https://i.imgur.com/NeszsmV.png" title="source: imgur.com" /></div>

De volta ao **Debugger do JWT**, se passarmos o Mouse sobre o item **iat** do **payload**, ser√° exibida a data, a hora e o fuso hor√°rio em que o token foi gerado. se passarmos o Mouse sobre o item **exp** do **payload**, ser√° exibida a data, a hora e o fuso hor√°rio em que o token vai expirar. Observe que d√° **exatamente 24 horas**, conforme configuramos a propriedade **expiresIn**.

> **iat (issued at)**: Identifica quando o Token JWT foi criado.
>
> **exp (expiration time)**: Identifica o tempo de expira√ß√£o do Token JWT.

**Linha 19:** As Classes **LocalStrategy e JwtStrategy** foram registradas no array **providers**, por se tratarem de duas Classes de Servi√ßo.

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao registrar Classes e M√≥dulos. Observe que ap√≥s registro, novas importa√ß√µes ser√£o necess√°rias nas primeiras linhas da Classe M√≥dulo.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/oScAYGc.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ATEN√á√ÉO:** *Se uma Classe for importada com o caminho absoluto (src/bcrypt/bcrypt), os testes da aplica√ß√£o com o framework Jest n√£o ser√£o executados. O Jest n√£o reconhece caminho absoluto, apenas caminho relativo (./bcrypt/bcrypt)* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="35px"/> <a href="https://www.rfc-editor.org/rfc/rfc7519#section-4.1" target="_blank"><b>Documenta√ß√£o: RFC7519 - Padroniza√ß√£o do JSON WEB Token</b></a></div>

<div align="left"><img src="https://i.imgur.com/WeNdbPo.png" title="source: imgur.com" width="35px"/> <a href="https://jwt.io/introduction" target="_blank"><b>Documenta√ß√£o: JWT - JSON WEB Token</b></a></div>

<div align="left"><img src="https://i.imgur.com/WeNdbPo.png" title="source: imgur.com" width="35px"/> <a href="https://jwt.io/" target="_blank"><b>Ferramenta: JWT Debugger</b></a></div>

<br />

Na parte 03 vamos finalizar a implementa√ß√£o do M√≥dulo Auth e faremos os testes no Insomnia...

<br /><br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>
