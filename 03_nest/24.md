<h1>Projeto 02 - Blog Pessoal - M√≥dulo Auth - Parte 03</h1>

O que veremos por aqui:

1. Criar a Classe AuthService
2. Criar a Classe AuthController
3. Registrar as Classes AuthService e AuthController na Classe AuthModule
4. Atualizar todas as Classes Controladoras
5. Testar o M√©todo Login no Insomnia
6. Atualizar todas as Requisi√ß√µes dos M√≥dulos Usuario, Tema e Postagem

<h2>1. O M√≥dulo Auth</h2>

Nesta etapa vamos finalizar a implementa√ß√£o da seguran√ßa da aplica√ß√£o atrav√©s da Biblioteca Passport. Iremos implementar as 2 ultimas Classes do M√≥dulo Auth: **AuthService** (Classe de Servi√ßo do M√≥dulo Auth) e **AuthController** (Classe Controladora do M√≥dulo Auth).

<br />

<h2>üë£ Passo 01 - Criar a Classe AuthService</h2>

Vamos criar a pasta **services**, dentro do nosso **M√≥dulo Auth** (pasta auth):

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="220px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar Classe de Servi√ßo. Um erro muito comum √© digitar o nome da Classe de forma incorreta. O nome da Classe deve estar dentro dos padr√µes do Nest (nome_do_modulo.tipo_da_classe.ts) para evitar erros na sua aplica√ß√£o.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

1. Clique com o bot√£o direito do mouse sobre a **pasta services**, que foi criada dentro da pasta **auth**, como mostra a figura abaixo, e na sequ√™ncia clique na op√ß√£o **New File** (Novo Arquivo).

2. O nome do arquivo ser√° **auth.service.ts**, como mostra a figura abaixo. Ap√≥s digitar o nome do arquivo, pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/cEIui2J.png" title="source: imgur.com" /></div>

Veja abaixo a implementa√ß√£o da Classe **AuthService**:

```typescript
import { Injectable } from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { UsuarioService } from '../../usuario/services/usuario.service';
import { Bcrypt } from '../bcrypt/bcrypt';

@Injectable()
export class AuthService {
  constructor(
    private usuarioService: UsuarioService,
    private jwtService: JwtService,
    private bcrypt: Bcrypt
  ) { }

  async validateUser(username: string, password: string): Promise<any> {

    const buscaUsuario = await this.usuarioService.findByUsuario(username)

    const match = await this.bcrypt.compararSenhas(buscaUsuario.senha, password)

    if (buscaUsuario && match) {
      const { senha, ...result } = buscaUsuario;
      return result;
    }
    return null;
  }

  async login(usuarioLogin: any) {

    const payload = { username: usuarioLogin.usuario, sub: "blogpessoal" };

    return {
      usuario: usuarioLogin.usuario,
      token: `Bearer ${this.jwtService.sign(payload)}`,
    };
    
  }

}
```

Vamos analisar a implementa√ß√£o do c√≥digo, com foco nas diferen√ßas em rela√ß√£o aos M√≥dulos anteriores:

<h3> 1.1 M√©todo Constructor()</h3>

O M√©todo **Constructor()** recebe as **Inje√ß√µes de Depend√™ncia** necess√°rias para o desenvolvimento da Classe de Servi√ßo.

<div align="center"><img src="https://i.imgur.com/LTcg323.png" title="source: imgur.com" /></div>

**Linha 10:** Al√©m da Inje√ß√£o de Depend√™ncia da Classe de Servi√ßo usuarioService, o M√©todo receber√° outras duas  Inje√ß√µes de Depend√™ncia:

- **Classe JwtService**, Classe de Servi√ßo respons√°vel por gerar o Token JWT.
- **Classe Bcrypt**, que foi criada como uma Classe de Servi√ßo no M√≥dulo Auth, respons√°vel por checar se o **Atributo senha do Objeto da Classe UsuarioLogin** (senha n√£o criptografada), √© igual ao **Atributo senha do Objeto da Classe Usuario** (criptografada) persistido no Banco de dados.



<h3> 1.2 M√©todo validateUser(username: string, password: string)</h3>

O M√©todo **validateUser(username: string, password: string)** ser√° respons√°vel por **validar os Atributos usuario (e-mail) e a senha** enviados no Objeto UsuarioLogin. Caso os dados dos 2 Atributos sejam validados, o usu√°rio ser√° autenticado.

<div align="center"><img src="https://i.imgur.com/iXySFtS.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo do M√©todo:

**Linha 14:** Criamos o M√©todo Ass√≠ncrono (async), chamado **validateUser(username: string, password: string)**, que promete retornar uma **Promise** com **apenas um** Objeto do tipo **any**.

Observe que o M√©todo **validateUser(username: string, password: string)** possui dois par√¢metros do tipo **string**, chamados **usuario e senha**. Estes par√¢metros ser√£o recebidos na autentica√ß√£o (login) do usu√°rio.

**Linha 16:** Criamos um Objeto da Classe Usuario do tipo **const**, chamado **buscaUsuario**, que receber√° o resultado da execu√ß√£o do M√©todo **findByUsuario(usuario: Usuario)**, da Classe **UsuarioService**, que valida se o usu√°rio existe.

**Linha 18:** Criamos uma **const**, chamada **match**, que receber√° o resultado da execu√ß√£o do M√©todo ****, da Classe **Bcrypt**, que valida se a senha persistida no Banco de dados e a senha enviada no Objeto UsuarioLogin s√£o iguais. Este M√©todo retornar√° true (o termo correto √© Match), caso as senhas sejam iguais.

Veja o exemplo nas imagens abaixo:

<table>
	<tr>
		<td width="50%"><img src="https://i.imgur.com/YCGbZwt.png" title="source: imgur.com" /></td>
		<td width="50%"><img src="https://i.imgur.com/EHEdZea.png" title="source: imgur.com" /></td>
	</tr>
</table>
O site **Bcrypt Generator** simula o funcionamento do algoritmo hash Bcrypt. Observe que inserimos a mesma senha criptografada nas 2 imagens e s√≥ alteramos a senha digitada. Na primeira imagem, que inserimos a senha correta, o site exibe **Match! (true)**, enquanto na segunda imagem, que inserimos a senha incorreta, o site exibe **Not a Match! (false)**. O M√©todo **compararSenhas(senhaBanco: string, senhaDigitada: string)** faz a mesma coisa: Decodifica a senha criptografada e compara com a senha n√£o codificada.

**Linha 20:** Verifica se o **Objeto buscaUsuario foi encontrado** e se a **vari√°vel match √© igual a true**. 

**Linha 21:** Se as 2 condi√ß√µes forem verdadeiras, ser√° criado um Objeto chamado **result** do tipo **const**, retornando o **Objeto Usuario encontrado sem o Atributo senha**, por quest√µes de seguran√ßa e boas pr√°ticas.

**Linha 24:** Se as 2 condi√ß√µes forem falsas, o M√©todo retorna **null** e a aplica√ß√£o retornar√° o HTTP Status **UNAUTHORIZED ü°™ 401** (Acesso n√£o autorizado!).

<h3> 1.3 M√©todo login(usuarioLogin: any)</h3>

O M√©todo **login(usuarioLogin: any)** ser√° respons√°vel por **autenticar (login) um usuario na aplica√ß√£o**. Este M√©todo √© essencial para o funcionamento do **Passport**, porqu√™ sem a autentica√ß√£o n√£o ser√° poss√≠vel acessar aplica√ß√£o e gerar o Token JWT. 

<div align="center"><img src="https://i.imgur.com/fM4Trr7.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo do M√©todo:

**Linha 27:** Criamos o M√©todo Ass√≠ncrono (async), chamado **login(usuarioLogin: any)**.

Observe que o M√©todo **login(usuarioLogin: any)** possui um par√¢metro do tipo **UsuarioLogin**, chamado **usuario**Login. Esta vari√°vel receber√° um Objeto da Classe UsuarioLogin, que ser√° enviado  no Corpo da Requisi√ß√£o (Request Body). O Objeto usuarioLogin ser√° enviado pelo M√©todo da **Classe UsuarioController**, atrav√©s de um **JSON**, semelhante ao exemplo abaixo:

```json
{
    "usuario" : "admin@email.com.br",
    "senha" : "admin123"
}
```

Observe que todos os Atributos da Classe Auxiliar UsuarioLogin ser√£o preenchidos.

Ao receber os dados do Objeto usuarioLogin, o Passport envia o Objeto para a Classe **LocalStrategy**, que est√° esperando por um Objeto contendo os Atributos usuario e senha, e ao receber os 2 Atributos ela se encarregar√° da autentica√ß√£o (login) do usu√°rio. 

Enquanto isso, o M√©todo **login(usuarioLogin: any)** se encarregar√° de gerar o Token JWT, como veremos nas pr√≥ximas linhas.

**Linha 29:** Criamos um Objeto do tipo const, chamado **payload**, que ser√° utilizado na gera√ß√£o do Token JWT. Este Objeto ter√° 2 par√¢metros:

- **username (usu√°rio):** recebe o Atributo usuario (e-mail)
- **sub (subject):** recebe uma string com o nome do projeto (blogpessoal)

Na imagem abaixo vemos a estrutura b√°sica de um Token JWT:

<div align="center"><img src="https://i.imgur.com/fj6noCZ.png" title="source: imgur.com" /></div>

Observe que ele √© composto pelo **Header** (cabe√ßalho), **Payload** (dados do usuario) e a **Signature** (chave de assinatura). O Payload √© a parte customizada do Token, onde definimos as **Claims** (peda√ßos de informa√ß√µes sobre o usuario e o projeto), que desejamos enviar no Token JWT.

**Linhas 31, 32 e 33:** Caso a autentica√ß√£o (login) tenha sido bem sucedido, ser√° retornado um JSON com dois atributos:

- **usuario**
- **Token**, que ser√° gerado a partir do M√©todo **jwtService.sign(payload)**

Observe que o M√©todo **jwtService.sign(payload)** criar√° apenas a parte codificada do Token JWT, por isso foi inserida a palavra **Bearer**, seguida de **um espa√ßo em branco**, **concatenada com a parte codificada do Token JWT**. O **espa√ßo em branco entre a palavra Bearer e a parte codificada do Token JWT √© Obrigat√≥rio!**, caso contr√°rio o Token JWT n√£o ir√° funcionar.

Observe tamb√©m que o Token est√° inserido dentro **2 acentos grave ( ` )**, utilizado na L√≠ngua Portuguesa para indicar um crase, ao inv√©s de aspas simples ( ' ). Veja o trecho destacado na imagem abaixo:

<div align="center"><img src="https://i.imgur.com/sNUXmf9.png" title="source: imgur.com" /></div>

No caso de uma autentica√ß√£o bem sucedida, o retorno esperado do M√©todo **login(usuarioLogin: any)** ser√° um JSON contendo o usuario e o token, como mostra o exemplo abaixo:

```json
{
	"usuario": "admin@email.com.br",
	"token": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluQGVtYWlsLmNvbS5iciIsInN1YiI6ImJsb2dwZXNzb2FsIiwiaWF0IjoxNjU5NjY5MzYwLCJleHAiOjE2NTk3NTU3NjB9.xvlBIb2TSofhpGv6spqRu903vjXCImWKrdqfgwCVf7w"
}
```

<br />

<div align="left"><img src="https://i.imgur.com/RlHVydi.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/kelektiv/node.bcrypt.js#readme" target="_blank"><b>Documenta√ß√£o: Biblioteca Bcrypt JS</b></a> </div>

<div align="left"><img src="https://i.imgur.com/RlHVydi.png" title="source: imgur.com" width="25px"/> <a href="https://bcrypt-generator.com/" target="_blank"><b>Ferramenta: Bcrypt Generator</b></a> </div>

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/13_Security_JWT/blogpessoal/src/auth/services/auth.service.ts" target="_blank"><b>C√≥digo fonte da Classe AuthService</b></a></div>

<br />
